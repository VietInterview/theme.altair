angular.module("ui.tinymce",[]).value("uiTinymceConfig",{}).directive("uiTinymce",["$rootScope","$compile","$timeout","$window","$sce","uiTinymceConfig",function($rootScope,$compile,$timeout,$window,$sce,uiTinymceConfig){uiTinymceConfig=uiTinymceConfig||{};var generatedIds=0,ID_ATTR="ui-tinymce";return uiTinymceConfig.baseUrl&&(tinymce.baseURL=uiTinymceConfig.baseUrl),{require:["ngModel","^?form"],link:function(scope,element,attrs,ctrls){function toggleDisable(disabled){disabled?(ensureInstance(),tinyInstance&&tinyInstance.getBody().setAttribute("contenteditable",!1)):(ensureInstance(),tinyInstance&&!tinyInstance.settings.readonly&&tinyInstance.getBody().setAttribute("contenteditable",!0))}function ensureInstance(){tinyInstance||(tinyInstance=tinymce.get(attrs.id))}if($window.tinymce){var expression,tinyInstance,ngModel=ctrls[0],form=ctrls[1]||null,options={},updateView=function(editor){var content=editor.getContent({format:options.format}).trim();content=$sce.trustAsHtml(content),ngModel.$setViewValue(content),$rootScope.$$phase||scope.$apply()};attrs.$set("id",ID_ATTR+"-"+generatedIds++),expression={},angular.extend(expression,scope.$eval(attrs.uiTinymce));var setupOptions={setup:function(ed){ed.on("init",function(){ngModel.$render(),ngModel.$setPristine(),form&&form.$setPristine()}),ed.on("ExecCommand",function(){ed.save(),updateView(ed)}),ed.on("change",function(){ed.save(),updateView(ed)}),ed.on("blur",function(){element[0].blur()}),ed.on("ObjectResized",function(){ed.save(),updateView(ed)}),ed.on("remove",function(){element.remove()}),expression.setup&&expression.setup(ed,{updateView:updateView})},format:expression.format||"html",selector:"#"+attrs.id};angular.extend(options,uiTinymceConfig,expression,setupOptions),$timeout(function(){tinymce.init(options),toggleDisable(scope.$eval(attrs.ngDisabled))}),ngModel.$formatters.unshift(function(modelValue){return modelValue?$sce.trustAsHtml(modelValue):""}),ngModel.$parsers.unshift(function(viewValue){return viewValue?$sce.getTrustedHtml(viewValue):""}),ngModel.$render=function(){ensureInstance();var viewValue=ngModel.$viewValue?$sce.getTrustedHtml(ngModel.$viewValue):"";tinyInstance&&tinyInstance.getDoc()&&(tinyInstance.setContent(viewValue),tinyInstance.fire("change"))},attrs.$observe("disabled",toggleDisable),scope.$on("$tinymce:refresh",function(e,id){var eid=attrs.id;if(angular.isUndefined(id)||id===eid){var parentElement=element.parent(),clonedElement=element.clone();clonedElement.removeAttr("id"),clonedElement.removeAttr("style"),clonedElement.removeAttr("aria-hidden"),tinymce.execCommand("mceRemoveEditor",!1,eid),parentElement.append($compile(clonedElement)(scope))}}),scope.$on("$destroy",function(){ensureInstance(),tinyInstance&&(tinyInstance.remove(),tinyInstance=null)})}}}}]);